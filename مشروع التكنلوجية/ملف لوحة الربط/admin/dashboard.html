<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <link rel="stylesheet" href="style.css">
    <script>
        if (!sessionStorage.getItem('isAdmin')) window.location.href = 'login.html';
    </script>
</head>
<body>
    <div class="dashboard-container">
        <header>
            <div class="header-content">
                <h1>âš¡ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                <button onclick="logout()" class="btn-small">Ø®Ø±ÙˆØ¬</button>
            </div>
            
            <!-- Quick Stats in Header -->
            <div class="stats-bar">
                <span>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª: <strong id="totalCount">0</strong></span>
                <span>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: <strong id="avgRating">0.0</strong></span>
                <span>Ù‡Ø¬Ù…Ø§Øª: <strong id="attackedPercentage">0%</strong></span>
            </div>
        </header>

        <div class="main-grid">
            <!-- Right Column: Content Management -->
            <section class="panel">
                <div class="panel-header">
                    <h2>Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø·</h2>
                    <button onclick="toggleAddForm()" class="btn-icon" title="Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯">â•</button>
                </div>

                <form id="addForm" class="add-form hidden" onsubmit="addLink(event)">
                    
                    <!-- File Selection -->
                    <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 4px; border: 1px dashed #555;">
                        <label style="display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9rem;">1. Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù (Ø£Ùˆ Ø§Ø¯Ø®Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠØ§Ù‹):</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="file" id="filePicker" onchange="handleFileSelect(this)" style="width: 50%;">
                            <input type="text" name="url" id="urlInput" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø· (URL)" required style="width: 50%; direction: ltr;">
                        </div>
                        <p style="font-size: 0.7rem; color: #ce9178; margin-top: 5px;">* Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.</p>
                    </div>

                    <!-- Category Selection -->
                    <div style="margin-top: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9rem;">2. Ø£ÙŠÙ† ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŸ (Ø§Ù„Ù‚Ø³Ù…):</label>
                        <select name="category" onchange="handleCategory(this)" style="width: 100%; padding: 10px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px;">
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>
                            <option value="articles">ğŸ“„ ØµÙØ­Ø© Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª (Articles)</option>
                            <option value="posters">ğŸ–¼ï¸ Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙˆØ³ØªØ±Ø§Øª (Posters)</option>
                            <option value="videos">ğŸ¬ Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª (Videos)</option>
                            <option value="main">ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Main Dashboard)</option>
                        </select>
                    </div>

                    <!-- Hidden/Auto-filled Fields -->
                    <input type="hidden" name="icon" id="iconInput">
                    
                    <!-- Advanced Details Toggle -->
                    <div style="margin-top: 15px;">
                         <button type="button" onclick="toggleDetails()" style="background:none; border:none; color: #aaa; cursor:pointer; font-size: 0.8rem; text-decoration: underline;">+ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (Ø§Ù„Ø¹Ù†ÙˆØ§Ù†/Ø§Ù„ÙˆØµÙ)</button>
                    </div>

                    <div id="advancedFields" class="hidden" style="margin-top: 10px; border-top: 1px dashed #444; padding-top: 10px;">
                         <label style="display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9rem;">3. ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                        <input type="text" name="title" id="titleInput" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)">
                        <input type="text" name="description" placeholder="Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                    </div>

                    <button type="submit" class="btn-primary" style="margin-top: 15px; width: 100%; padding: 12px; font-size: 1.1rem;">âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ù ÙÙˆØ±Ø§Ù‹</button>
                </form>

                <div class="tabs" style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; flex-wrap: wrap;" id="tabsContainer">
                    <button onclick="switchTab('main')" class="tab-btn active" id="tab-main">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                    <button onclick="switchTab('articles')" class="tab-btn" id="tab-articles">ğŸ“„ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª</button>
                    <button onclick="switchTab('posters')" class="tab-btn" id="tab-posters">ğŸ–¼ï¸ Ø§Ù„Ø¨ÙˆØ³ØªØ±Ø§Øª</button>
                    <button onclick="switchTab('videos')" class="tab-btn" id="tab-videos">ğŸ¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</button>
                    <!-- New Sections appear here -->
                    <button onclick="createNewSection()" class="tab-btn" style="color: #4ec9b0;">+ Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</button>
                </div>

                <div id="linksList" class="items-list"></div>
                
                <!-- Restore Link -->
                <div style="margin-top: 20px; text-align: left;">
                     <button onclick="restoreDefaults()" style="background: none; border: 1px solid #444; color: #888; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">â†º Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø¨ÙˆØ³ØªØ±ØŒ Ù…Ù‚Ø§Ù„Ø§Øª...)</button>
                </div>
            </section>

            <!-- Left Column: Feedback -->
            <section class="panel">
                <div class="panel-header">
                    <h2>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h2>
                    <button onclick="clearAllFeedback()" class="btn-text">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
                    <!-- Hidden Reset Button for emergency -->
                    <button onclick="resetDefaults()" style="opacity: 0.2; font-size: 0.6rem; margin-right: auto;">Reset</button>
                </div>
                <div id="feedbackContainer" class="items-list"></div>
            </section>
        </div>
    </div>

    <script>
        // Data
        let surveyData = JSON.parse(localStorage.getItem('ransomware_survey_data') || '[]');
        
        // Multi-source Data Managers
        const StorageKeys = {
            'main': 'dashboard_links',
            'articles': 'articles_data',
            'posters': 'posters_data',
            'videos': 'videos_data'
        };
        
        let currentTab = 'main';

        function getData(type) {
            return JSON.parse(localStorage.getItem(StorageKeys[type]) || '[]');
        }

        function saveData(type, data) {
            localStorage.setItem(StorageKeys[type], JSON.stringify(data));
        }

        function logout() {
            sessionStorage.removeItem('isAdmin');
            window.location.href = 'login.html';
        }

        function toggleAddForm() {
            document.getElementById('addForm').classList.toggle('hidden');
        }

        function switchTab(tab) {
            currentTab = tab;
            // Update UI Buttons
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            updateUI();
        }

        function toggleDetails() {
            document.getElementById('advancedFields').classList.toggle('hidden');
        }

        // Logic
        function updateUI() {
            // Stats
            document.getElementById('totalCount').textContent = surveyData.length;
            const sum = surveyData.reduce((acc, curr) => acc + parseInt(curr.rating), 0);
            document.getElementById('avgRating').textContent = surveyData.length ? (sum / surveyData.length).toFixed(1) : '0.0';
            const attackedCount = surveyData.filter(item => item.attacked === 'yes').length;
            document.getElementById('attackedPercentage').textContent = surveyData.length ? Math.round((attackedCount / surveyData.length) * 100) + '%' : '0%';

            // Links / Content List based on Current Tab
            const listContainer = document.getElementById('linksList');
            listContainer.innerHTML = '';
            
            const currentData = getData(currentTab);
            
            if (currentData.length === 0) {
                 listContainer.innerHTML = '<p class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</p>';
            } else {
                currentData.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'item-row';
                    div.innerHTML = `
                        <div class="item-info">
                            <span class="item-icon">${item.icon}</span>
                            <span>${item.title}</span>
                            <span style="font-size: 0.8rem; color: #666; margin-right: 5px;">(${item.url})</span>
                        </div>
                        <div class="actions" style="display:flex; gap:5px;">
                            <button onclick="moveItem(${index}, -1)" class="btn-small" title="Move Up">â¬†ï¸</button>
                            <button onclick="moveItem(${index}, 1)" class="btn-small" title="Move Down">â¬‡ï¸</button>
                            <button onclick="deleteItem(${index})" class="bin-btn">ğŸ—‘ï¸</button>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            }

            // Feedback
            const feedbackContainer = document.getElementById('feedbackContainer');
            feedbackContainer.innerHTML = '';
            if (surveyData.length === 0) {
                feedbackContainer.innerHTML = '<p class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</p>';
            } else {
                surveyData.slice().reverse().forEach((item, index) => {
                    const originalIndex = surveyData.length - 1 - index;
                    const div = document.createElement('div');
                    div.className = 'item-block';
                    div.innerHTML = `
                        <div class="item-header">
                            <span class="badg">${item.rating}â­</span>
                            <span class="date">${item.date}</span>
                            <button onclick="deleteFeedback(${originalIndex})" class="bin-btn-small">Ã—</button>
                        </div>
                        <p>${item.comment || '-'}</p>
                        ${item.attacked === 'yes' ? '<span class="alert-tag">âš ï¸ ØªØ¹Ø±Ø¶ Ù„Ù‡Ø¬ÙˆÙ…</span>' : ''}
                    `;
                    feedbackContainer.appendChild(div);
                });
            }
        }

        // Actions
        function handleFileSelect(input) {
            if (input.files.length > 0) {
                const fileName = input.files[0].name;
                document.getElementById('urlInput').value = fileName;
                if (!document.getElementById('titleInput').value) {
                    const title = fileName.split('.').slice(0, -1).join('.');
                    document.getElementById('titleInput').value = title;
                }
            }
        }

        function handleCategory(select) {
            const mapping = {
                'articles': {'icon': 'ğŸ“„'},
                'posters': {'icon': 'ğŸ–¼ï¸'},
                'videos': {'icon': 'ğŸ¬'},
                'main': {'icon': 'ğŸ”—'}
            };
            if (select.value && mapping[select.value]) {
                document.getElementById('iconInput').value = mapping[select.value].icon;
            }
        }

        function addLink(e) {
            e.preventDefault();
            const f = e.target;
            const targetSection = f.category.value;
            
            if (!targetSection) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù…!'); return; }

            const newItem = {
                title: f.title.value || f.url.value || 'Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯',
                url: f.url.value,
                icon: f.icon.value || 'ğŸ”—',
                description: f.description.value || 'Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯'
            };

            const data = getData(targetSection);
            data.push(newItem);
            saveData(targetSection, data);

            f.reset();
            f.classList.add('hidden');
            
            // Switch to the tab where we just added the item
            switchTab(targetSection);
            alert('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­!');
        }

        function deleteItem(index) {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) {
                const data = getData(currentTab);
                data.splice(index, 1);
                saveData(currentTab, data);
                updateUI();
            }
        }

        function moveItem(index, direction) {
            const data = getData(currentTab);
            const newIndex = index + direction;
            
            // Boundary checks
            if (newIndex < 0 || newIndex >= data.length) return;
            
            // Swap
            const temp = data[index];
            data[index] = data[newIndex];
            data[newIndex] = temp;
            
            saveData(currentTab, data);
            updateUI();
        }

        function deleteFeedback(index) {
            if(confirm('Ø­Ø°ÙØŸ')) {
                surveyData.splice(index, 1);
                localStorage.setItem('ransomware_survey_data', JSON.stringify(surveyData));
                updateUI();
            }
        }

        function clearAllFeedback() {
            if(confirm('Ø­Ø°Ù Ø§Ù„ÙƒÙ„ØŸ')) {
                surveyData = [];
                localStorage.removeItem('ransomware_survey_data');
                updateUI();
            }
        }

        // Initial Load of Custom Sections
        let customSections = JSON.parse(localStorage.getItem('custom_sections') || '[]');

        function initTabs() {
            const tabsContainer = document.getElementById('tabsContainer');
            // Remove old custom tabs first (all after the + button, but we append before it actually)
            // Easier: just reload standard ones and append custom
            
            // Render custom section buttons
            customSections.forEach(sec => {
                if (document.getElementById(`tab-${sec.id}`)) return; // already exists
                
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.id = `tab-${sec.id}`;
                btn.textContent = `ğŸ“ ${sec.title}`;
                btn.onclick = () => switchTab(sec.id);
                
                // Insert before the "+ New Section" button (last child)
                const addBtn = tabsContainer.lastElementChild;
                tabsContainer.insertBefore(btn, addBtn);
            });
            
            // Update Select Dropdown
             const select = document.getElementsByName('category')[0];
             customSections.forEach(sec => {
                 // Check if option exists
                 let exists = false;
                 for(let i=0; i<select.options.length; i++) {
                     if(select.options[i].value === sec.id) exists = true;
                 }
                 
                 if(!exists) {
                     const opt = document.createElement('option');
                     opt.value = sec.id;
                     opt.textContent = `ğŸ“ ${sec.title} (Ù‚Ø³Ù… Ø®Ø§Øµ)`;
                     select.appendChild(opt);
                 }
             });
        }

        function createNewSection() {
            const title = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ù„Ø§Ù‹: Ø£Ù„Ø¹Ø§Ø¨ØŒ Ø´Ù‡Ø§Ø¯Ø§Øª):');
            if (!title) return;
            
            const id = 'section_' + Date.now();
            
            // 1. Add to Custom Sections List
            customSections.push({ id: id, title: title });
            localStorage.setItem('custom_sections', JSON.stringify(customSections));
            
            // 2. Add Link to Main Dashboard automatically
            const newItem = {
                title: title,
                url: `viewer.html?id=${id}&title=${encodeURIComponent(title)}`,
                icon: 'ğŸ“',
                description: 'Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯'
            };
            let mainLinks = JSON.parse(localStorage.getItem('dashboard_links') || '[]');
            mainLinks.push(newItem);
            localStorage.setItem('dashboard_links', JSON.stringify(mainLinks));

            alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø³Ù… ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©!');
            location.reload(); // Reload to refresh tabs and dropdowns
        }

        function restoreDefaults() {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¨ÙˆØ³ØªØ±ØŒ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§ØªØŒ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙÙ‚ÙˆØ¯Ø©.')) {
                // We don't want to wipe everything, just ensure defaults exist
                const defaultLinks = [
                    { title: "Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹", url: "site_wrapper.html", icon: "ğŸ’»", description: "Project Website" },
                    { title: "Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†", url: "survey/index.html", icon: "ğŸ“Š", description: "Survey Form" },
                    { title: "Ø£Ø³Ø¦Ù„Ø©", url: "questions/quiz.html", icon: "â“", description: "Questions & Quiz" },
                    { title: "Ø¨ÙˆØ³ØªØ±", url: "posters/index.html", icon: "ğŸ–¼ï¸", description: "Project Posters" },
                    { title: "Ù…Ù‚Ø§Ù„Ø§Øª", url: "articles/index.html", icon: "ğŸ“°", description: "Articles" },
                    { title: "ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª", url: "videos/index.html", icon: "ğŸ¬", description: "Educational Videos" }
                ];
                
                let current = JSON.parse(localStorage.getItem('dashboard_links') || '[]');
                
                // Merge logic: Add if URL doesn't exist
                let added = false;
                defaultLinks.forEach(def => {
                    if (!current.some(c => c.url === def.url)) {
                        current.push(def);
                        added = true;
                    }
                });
                
                if(added) {
                    localStorage.setItem('dashboard_links', JSON.stringify(current));
                    alert('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©!');
                    location.reload();
                } else {
                    alert('Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„.');
                }
            }
        }
        
        // --- Tab Logic Update ---
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`tab-${tab}`);
            if(btn) btn.classList.add('active');
            updateUI();
        }

        function getData(type) {
            // Check if it's a custom section
            if (type.startsWith('section_')) {
                return JSON.parse(localStorage.getItem(`${type}_data`) || '[]');
            }
            return JSON.parse(localStorage.getItem(StorageKeys[type]) || '[]');
        }

        function saveData(type, data) {
            // Check if it's a custom section
            if (type.startsWith('section_')) {
                localStorage.setItem(`${type}_data`, JSON.stringify(data));
                return;
            }
            localStorage.setItem(StorageKeys[type], JSON.stringify(data));
        }

        // Init
        initTabs();
        updateUI();
    </script>
</body>
</html>
